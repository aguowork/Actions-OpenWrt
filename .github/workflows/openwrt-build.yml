#
# https://github.com/P3TERX/Actions-OpenWrt
# MT798x ç³»åˆ—è·¯ç”±å™¨å›ºä»¶è‡ªåŠ¨ç¼–è¯‘è„šæœ¬

name: MT798x OpenWrt Build

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      devices:
        description: 'é€‰æ‹©è¦ç¼–è¯‘çš„è®¾å¤‡ (å¤šé€‰ç”¨é€—å·åˆ†éš”: AX6000,WR30U,360T7)'
        required: true
        default: 'AX6000,WR30U,360T7'

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x.git
  REPO_BRANCH: openwrt-21.02
  FEEDS_CONF: feeds.conf.default
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  WXPUSHER_TOKEN: ${{ secrets.WXPUSHER_TOKEN }}
  WXPUSHER_UIDS: ${{ secrets.WXPUSHER_UIDS }}

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Initialize Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/P3TERX/Actions-OpenWrt/master/depends-ubuntu-2204)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        echo "START_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        echo "BUILD_RESULTS=" >> $GITHUB_ENV

    - name: Clone Source Code
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: Update & Install Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Build Firmware
      id: build
      run: |
        IFS=',' read -ra DEVICES <<< "${{ github.event.inputs.devices }}"
        results=""
        
        for device in "${DEVICES[@]}"; do
          device_start_time=$(date '+%Y-%m-%d %H:%M:%S')
          echo "å¼€å§‹ç¼–è¯‘ ${device} å›ºä»¶..."
          
          # è®¾ç½®è®¾å¤‡ç‰¹å®šçš„é…ç½®æ–‡ä»¶
          CONFIG_FILE="./config/21.02/immortalwrtARM/${device}/${device}-mtwifi-cfg.config"
          DIY_P1_SH="./diy/21.02/immortalwrtARM/${device}/diy-part1.sh"
          DIY_P2_SH="./diy/21.02/immortalwrtARM/${device}/diy-part2.sh"
          
          # åŠ è½½é…ç½®
          cd openwrt
          [ -e $CONFIG_FILE ] && cp $CONFIG_FILE .config
          [ -e $DIY_P1_SH ] && chmod +x $DIY_P1_SH && $GITHUB_WORKSPACE/$DIY_P1_SH
          [ -e $DIY_P2_SH ] && chmod +x $DIY_P2_SH && $GITHUB_WORKSPACE/$DIY_P2_SH
          
          # ç¼–è¯‘å›ºä»¶
          make defconfig
          make download -j8
          make -j$(nproc) || make -j1 V=s

          # åˆ¤æ–­ç¼–è¯‘æ˜¯å¦æˆåŠŸï¼ŒæˆåŠŸåˆ™è®°å½•å›ºä»¶é“¾æ¥ï¼Œå¤±è´¥åˆ™è®°å½•å¤±è´¥æ—¶é—´
          if [ $? -eq 0 ]; then
            status="success"
            device_end_time=$(date '+%Y-%m-%d %H:%M:%S')
            firmware_link="https://github.com/${{ github.repository }}/releases/download/latest/${device}-firmware.bin"
            results="${results}${device}|${status}|${device_start_time}|${device_end_time}|${firmware_link}\n"
          else
            status="failed"
            device_end_time=$(date '+%Y-%m-%d %H:%M:%S')
            results="${results}${device}|${status}|${device_start_time}|${device_end_time}|\n"
          fi
          
          cd $GITHUB_WORKSPACE
        done
        
        echo "BUILD_RESULTS<<EOF" >> $GITHUB_ENV
        echo -e "$results" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Send Build Notification
      if: always()
      run: |
        # ç”Ÿæˆé€šçŸ¥å†…å®¹
        notification="ğŸ”„ OpenWrt å›ºä»¶ç¼–è¯‘é€šçŸ¥\n"
        notification+="å¼€å§‹æ—¶é—´: ${{ env.START_TIME }}\n\n"
        notification+="ğŸ“‹ ç¼–è¯‘ç¯å¢ƒä¿¡æ¯ï¼š\n"
        notification+="â€¢ è¿è¡Œç¯å¢ƒ: Ubuntu 22.04\n"
        notification+="â€¢ æºç åˆ†æ”¯: ${REPO_BRANCH}\n"
        notification+="â€¢ æºç ä»“åº“: immortalwrt-mt798x\n\n"
        
        success_count=0
        fail_count=0
        
        while IFS='|' read -r device status start_time end_time link; do
          if [ "$status" == "success" ]; then
            notification+="âœ… ${device}\n"
            notification+="â±ï¸ ç¼–è¯‘å®Œæˆäº: $(date -d "$end_time" '+%mæœˆ%dæ—¥ %H:%M')\n"
            if [ -n "$link" ]; then
              notification+="ğŸ“¥ <copy data-clipboard-text=\"$link\">å¤åˆ¶ä¸‹è½½é“¾æ¥</copy>\n\n"
            fi
            ((success_count++))
          else
            notification+="âŒ ${device}\n"
            notification+="â±ï¸ ç¼–è¯‘å¤±è´¥äº: $(date -d "$end_time" '+%mæœˆ%dæ—¥ %H:%M')\n\n"
            ((fail_count++))
          fi
        done <<< "${{ env.BUILD_RESULTS }}"
        
        total=$((success_count + fail_count))
        duration=$(( $(date -d "$end_time" +%s) - $(date -d "${{ env.START_TIME }}" +%s) ))
        hours=$((duration / 3600))
        minutes=$(( (duration % 3600) / 60 ))
        
        notification+="ğŸ“Š ç¼–è¯‘ç»“æœç»Ÿè®¡\n"
        notification+="â€¢ å…± ${total} ä¸ªå›ºä»¶\n"
        notification+="â€¢ ${success_count} ä¸ªæˆåŠŸ\n"
        notification+="â€¢ ${fail_count} ä¸ªå¤±è´¥\n"
        notification+="âŒ› æ€»è€—æ—¶: ${hours}h${minutes}m\n"
        
        # å‘é€é€šçŸ¥
        curl -X POST \
          -H "Content-Type: application/json" \
          -d "{
            \"appToken\": \"${{ env.WXPUSHER_TOKEN }}\",
            \"content\": \"$notification\",
            \"summary\": \"OpenWrt å›ºä»¶ç¼–è¯‘å®Œæˆ\",
            \"contentType\": 2,
            \"uids\": [\"${{ env.WXPUSHER_UIDS }}\"]
          }" \
          https://wxpusher.zjiecode.com/api/send/message

    - name: Delete Old Releases
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Delete Workflow Runs
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2 
