name: OpenWrt å›ºä»¶è‡ªåŠ¨ç¼–è¯‘

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      device:
        description: 'é€‰æ‹©è®¾å¤‡'
        required: false
        type: choice
        options:
          - all
          - AX6000
          - WR30U
          - 360T7

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x.git
  REPO_BRANCH: openwrt-21.02
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  WORKDIR: /workdir

jobs:
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: æ£€æŸ¥è¾“å…¥
        id: set-matrix
        run: |
          if [ "${{ github.event.inputs.device }}" = "all" ] || [ -z "${{ github.event.inputs.device }}" ]; then
            echo "matrix={\"device\":[\"AX6000\",\"WR30U\",\"360T7\"]}" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"device\":[\"${{ github.event.inputs.device }}\"]}" >> $GITHUB_OUTPUT
          fi

  build:
    needs: prepare
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix: ${{fromJson(needs.prepare.outputs.matrix)}}

    steps:
      - name: åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/P3TERX/openwrt-build-env/master/build-env-on-ubuntu-focal)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.WORKDIR }}/openwrt/staging_dir
            ${{ env.WORKDIR }}/openwrt/build_dir
            ${{ env.WORKDIR }}/openwrt/dl
          key: openwrt-${{ matrix.device }}-${{ hashFiles('config/**/*.config') }}
          restore-keys: |
            openwrt-${{ matrix.device }}-

      - name: å…‹éš†æºç 
        run: |
          mkdir -p $WORKDIR
          cd $WORKDIR
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf $WORKDIR/openwrt $GITHUB_WORKSPACE/openwrt

      - name: æ›´æ–° feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åŠ è½½é…ç½®
        run: |
          [ -e files ] && cp -r files openwrt/files
          cp config/21.02/immortalwrtARM/${{ matrix.device }}/${{ matrix.device }}-mtwifi-cfg.config openwrt/.config
          cd openwrt
          bash $GITHUB_WORKSPACE/diy/21.02/immortalwrtARM/${{ matrix.device }}/diy-part2.sh

      - name: ä¸‹è½½ä¾èµ–
        run: |
          cd openwrt
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: æ•´ç†æ–‡ä»¶
        if: steps.compile.outputs.status == 'success'
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: å‘å¸ƒå›ºä»¶
        uses: softprops/action-gh-release@v1
        if: steps.compile.outputs.status == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ matrix.device }}_${{ env.FILE_DATE }}
          files: ${{ env.FIRMWARE }}/*
          generate_release_notes: true
          body: |
            ğŸ‰ OpenWrt å›ºä»¶å‘å¸ƒ
            
            ğŸ“± è®¾å¤‡: ${{ matrix.device }}
            â° ç¼–è¯‘æ—¶é—´: ${{ env.FILE_DATE }}
            ğŸ”— æºç : ${{ env.REPO_URL }}
            ğŸŒ¿ åˆ†æ”¯: ${{ env.REPO_BRANCH }}

      - name: å‘é€é€šçŸ¥
        if: always()
        uses: wxpusher/wxpusher-action@main
        with:
          appToken: ${{ secrets.WXPUSHER_APPTOKEN }}
          uids: ${{ secrets.WXPUSHER_UIDS }}
          content: |
            è®¾å¤‡: ${{ matrix.device }}
            çŠ¶æ€: ${{ steps.compile.outputs.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}
            æ—¶é—´: ${{ env.FILE_DATE }}
            ${{ steps.compile.outputs.status == 'success' && format('ä¸‹è½½: https://github.com/{0}/releases/tag/{1}_{2}', github.repository, matrix.device, env.FILE_DATE) || '' }}

  cleanup:
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - name: æ¸…ç†æ—§ç‰ˆæœ¬
        uses: dev-drprasad/delete-older-releases@v0.2.1
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}