name: 测试推送通知

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: 发送测试通知
      run: |
        # 检查必要的变量是否存在
        if [ -z "${{ secrets.WXPUSHER_TOKEN }}" ]; then
          echo "错误：未设置 WXPUSHER_TOKEN"
          exit 1
        fi
        
        if [ -z "${{ secrets.WXPUSHER_UIDS }}" ]; then
          echo "错误：未设置 WXPUSHER_UIDS"
          exit 1
        fi
        
        # 生成测试消息
        message="🔄 测试通知\n\n"
        message+="📋 测试信息：\n"
        message+="• 这是一条测试消息\n"
        message+="• 用于验证推送功能\n"
        
        # 将消息转换为 JSON 格式
        json_message=$(echo "$message" | jq -Rsa .)
        
        # 构建完整的 JSON 数据
        json_data="{
          \"appToken\": \"${{ secrets.WXPUSHER_TOKEN }}\",
          \"content\": ${json_message},
          \"summary\": \"OpenWrt 测试通知\",
          \"contentType\": 2,
          \"uids\": [\"${{ secrets.WXPUSHER_UIDS }}\"]
        }"
        
        # 输出请求数据（调试用）
        echo "发送的数据："
        echo "$json_data" | jq .
        
        # 发送请求
        response=$(curl -X POST \
          -H "Content-Type: application/json" \
          -d "$json_data" \
          https://wxpusher.zjiecode.com/api/send/message)
        
        # 输出响应结果
        echo "接口返回："
        echo "$response" | jq .