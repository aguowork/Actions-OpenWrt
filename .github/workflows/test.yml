name: æµ‹è¯•æ¨é€é€šçŸ¥

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  TZ: Asia/Shanghai

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
      run: |
        echo "START_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        # æ¨¡æ‹Ÿç¼–è¯‘ç»“æœ
        echo "BUILD_RESULTS<<EOF" >> $GITHUB_ENV
        echo -e "AX6000|success|2024-01-01 10:00:00|2024-01-01 10:30:00|https://example.com/AX6000.bin\nWR30U|failed|2024-01-01 10:00:00|2024-01-01 10:15:00|\n" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: å‘é€æµ‹è¯•é€šçŸ¥
      if: always()
      run: |
        if [ -z "${{ secrets.WXPUSHER_TOKEN }}" ] || [ -z "${{ secrets.WXPUSHER_UIDS }}" ]; then
          echo "é”™è¯¯ï¼šæœªè®¾ç½® WXPUSHER_TOKEN æˆ– WXPUSHER_UIDS"
          exit 1
        fi
        
        notification="ğŸ”„ æµ‹è¯•é€šçŸ¥\n"
        notification+="å¼€å§‹æ—¶é—´: ${{ env.START_TIME }}\n\n"
        notification+="ğŸ“‹ æµ‹è¯•ä¿¡æ¯ï¼š\n"
        notification+="â€¢ è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯\n"
        notification+="â€¢ ç”¨äºéªŒè¯æ¨é€åŠŸèƒ½\n\n"
        
        while IFS='|' read -r device status start_time end_time link; do
          if [ "$status" == "success" ]; then
            notification+="âœ… ${device}\n"
            notification+="â±ï¸ æµ‹è¯•å®Œæˆäº: $(date -d "$end_time" '+%mæœˆ%dæ—¥ %H:%M')\n"
            if [ -n "$link" ]; then
              notification+="ğŸ“¥ <copy data-clipboard-text=\"$link\">å¤åˆ¶ä¸‹è½½é“¾æ¥</copy>\n\n"
            fi
          else
            notification+="âŒ ${device}\n"
            notification+="â±ï¸ æµ‹è¯•å¤±è´¥äº: $(date -d "$end_time" '+%mæœˆ%dæ—¥ %H:%M')\n\n"
          fi
        done <<< "${{ env.BUILD_RESULTS }}"
        
        curl -X POST \
          -H "Content-Type: application/json" \
          -d "{
            \"appToken\": \"${{ secrets.WXPUSHER_TOKEN }}\",
            \"content\": \"$notification\",
            \"summary\": \"OpenWrt æµ‹è¯•é€šçŸ¥\",
            \"contentType\": 2,
            \"uids\": [\"${{ secrets.WXPUSHER_UIDS }}\"]
          }" \
          https://wxpusher.zjiecode.com/api/send/message