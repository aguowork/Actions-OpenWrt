name: æµ‹è¯•æ¨é€é€šçŸ¥

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: å‘é€æµ‹è¯•é€šçŸ¥
      run: |
        # æ£€æŸ¥å¿…è¦çš„å˜é‡æ˜¯å¦å­˜åœ¨
        if [ -z "${{ secrets.WXPUSHER_TOKEN }}" ]; then
          echo "é”™è¯¯ï¼šæœªè®¾ç½® WXPUSHER_TOKEN"
          exit 1
        fi
        
        if [ -z "${{ secrets.WXPUSHER_UIDS }}" ]; then
          echo "é”™è¯¯ï¼šæœªè®¾ç½® WXPUSHER_UIDS"
          exit 1
        fi
        
        # ç”Ÿæˆæµ‹è¯•æ¶ˆæ¯
        message="ğŸ”„ æµ‹è¯•é€šçŸ¥\n\n"
        message+="ğŸ“‹ æµ‹è¯•ä¿¡æ¯ï¼š\n"
        message+="â€¢ è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯\n"
        message+="â€¢ ç”¨äºéªŒè¯æ¨é€åŠŸèƒ½\n"
        
        # å°†æ¶ˆæ¯è½¬æ¢ä¸º JSON æ ¼å¼
        json_message=$(echo "$message" | jq -Rsa .)
        
        # æ„å»ºå®Œæ•´çš„ JSON æ•°æ®
        json_data="{
          \"appToken\": \"${{ secrets.WXPUSHER_TOKEN }}\",
          \"content\": ${json_message},
          \"summary\": \"OpenWrt æµ‹è¯•é€šçŸ¥\",
          \"contentType\": 2,
          \"uids\": [\"${{ secrets.WXPUSHER_UIDS }}\"]
        }"
        
        # è¾“å‡ºè¯·æ±‚æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
        echo "å‘é€çš„æ•°æ®ï¼š"
        echo "$json_data" | jq .
        
        # å‘é€è¯·æ±‚
        response=$(curl -X POST \
          -H "Content-Type: application/json" \
          -d "$json_data" \
          https://wxpusher.zjiecode.com/api/send/message)
        
        # è¾“å‡ºå“åº”ç»“æœ
        echo "æ¥å£è¿”å›ï¼š"
        echo "$response" | jq .