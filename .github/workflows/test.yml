name: æµ‹è¯•æ¨é€é€šçŸ¥

on:
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  WXPUSHER_TOKEN: ${{ secrets.WXPUSHER_TOKEN }}
  WXPUSHER_UIDS: ${{ secrets.WXPUSHER_UIDS }}

jobs:
  test-notification:
    runs-on: ubuntu-22.04

    steps:
    - name: åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
      run: |
        echo "START_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
        # æ¨¡æ‹Ÿä¸‰ä¸ªè®¾å¤‡çš„æˆåŠŸç¼–è¯‘ç»“æœ
        echo "BUILD_RESULTS<<EOF" >> $GITHUB_ENV
        echo "AX6000|success|2024-01-01 10:00:00|2024-01-01 10:30:00|https://github.com/${{ github.repository }}/releases/download/latest/AX6000-firmware.bin" >> $GITHUB_ENV
        echo "WR30U|success|2024-01-01 10:30:00|2024-01-01 11:00:00|https://github.com/${{ github.repository }}/releases/download/latest/WR30U-firmware.bin" >> $GITHUB_ENV
        echo "360T7|success|2024-01-01 11:00:00|2024-01-01 11:30:00|https://github.com/${{ github.repository }}/releases/download/latest/360T7-firmware.bin" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: å‘é€ç¼–è¯‘é€šçŸ¥
      if: always()
      run: |
        # æ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
        echo "DEBUG: æ£€æŸ¥ secrets æ˜¯å¦å­˜åœ¨"
        echo "WXPUSHER_TOKEN exists: ${{ secrets.WXPUSHER_TOKEN != '' }}"
        echo "WXPUSHER_UIDS exists: ${{ secrets.WXPUSHER_UIDS != '' }}"
        
        echo "DEBUG: æ‰“å°ç¯å¢ƒå˜é‡"
        echo "WXPUSHER_TOKEN é•¿åº¦: ${#WXPUSHER_TOKEN}"
        echo "WXPUSHER_UIDS é•¿åº¦: ${#WXPUSHER_UIDS}"
        
        # ä½¿ç”¨ç¯å¢ƒå˜é‡è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ secrets
        if [ -z "${WXPUSHER_TOKEN}" ] || [ -z "${WXPUSHER_UIDS}" ]; then
          echo "è­¦å‘Šï¼šWXPusher é…ç½®æœªè®¾ç½®ï¼Œè·³è¿‡é€šçŸ¥å‘é€"
          exit 0
        fi
        
        echo "DEBUG: é…ç½®éªŒè¯é€šè¿‡ï¼Œå¼€å§‹å‡†å¤‡é€šçŸ¥å†…å®¹"
        
        notification="ğŸ”„ OpenWrt å›ºä»¶ç¼–è¯‘é€šçŸ¥\n"
        notification+="å¼€å§‹æ—¶é—´: ${{ env.START_TIME }}\n\n"
        notification+="ğŸ“‹ ç¼–è¯‘ç¯å¢ƒä¿¡æ¯ï¼š\n"
        notification+="â€¢ è¿è¡Œç¯å¢ƒ: $(lsb_release -ds)\n"
        notification+="â€¢ æµ‹è¯•é€šçŸ¥\n\n"
        
        success_count=0
        fail_count=0

        while IFS='|' read -r device status start_time end_time link; do
          if [ "$status" == "success" ]; then
            notification+="âœ… ${device}\n"
            notification+="â±ï¸ ç¼–è¯‘å®Œæˆäº: $(date -d "$end_time" '+%mæœˆ%dæ—¥ %H:%M')\n"
            if [ -n "$link" ]; then
              notification+="ğŸ“¥ <copy data-clipboard-text=\"$link\">å¤åˆ¶ä¸‹è½½é“¾æ¥</copy>\n\n"
            fi
            ((success_count++))
          else
            notification+="âŒ ${device}\n"
            notification+="â±ï¸ ç¼–è¯‘å¤±è´¥äº: $(date -d "$end_time" '+%mæœˆ%dæ—¥ %H:%M')\n\n"
            ((fail_count++))
          fi
        done <<< "${{ env.BUILD_RESULTS }}"
        
        total=$((success_count + fail_count))
        
        notification+="ğŸ“Š ç¼–è¯‘ç»“æœç»Ÿè®¡\n"
        notification+="â€¢ å…± ${total} ä¸ªå›ºä»¶\n"
        notification+="â€¢ ${success_count} ä¸ªæˆåŠŸ\n"
        notification+="â€¢ ${fail_count} ä¸ªå¤±è´¥\n"
        notification+="âŒ› æ€»è€—æ—¶: 1h30m (æµ‹è¯•æ•°æ®)\n"
        
        echo "DEBUG: å‡†å¤‡å‘é€çš„é€šçŸ¥å†…å®¹:"
        echo "$notification"
        
        echo "DEBUG: å¼€å§‹å‘é€é€šçŸ¥"
        response=$(curl -v -X POST \
          -H "Content-Type: application/json" \
          -d "{
            \"appToken\": \"${WXPUSHER_TOKEN}\",
            \"content\": \"$notification\",
            \"summary\": \"OpenWrt å›ºä»¶ç¼–è¯‘å®Œæˆ\",
            \"contentType\": 2,
            \"uids\": [\"${WXPUSHER_UIDS}\"]
          }" \
          https://wxpusher.zjiecode.com/api/send/message 2>&1)
        
        echo "DEBUG: API å“åº”:"
        echo "$response"
        
        # æ£€æŸ¥ curl æ˜¯å¦æˆåŠŸ
        if [ $? -ne 0 ]; then
          echo "ERROR: å‘é€é€šçŸ¥å¤±è´¥"
          echo "$response"
          exit 1
        fi